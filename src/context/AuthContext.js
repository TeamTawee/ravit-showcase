"use client";
import { createContext, useContext, useEffect, useState } from "react";
import { onAuthStateChanged, signOut } from "firebase/auth";
import { auth } from "../lib/firebase"; 
import { useRouter, usePathname } from "next/navigation";
import { Loader2 } from "lucide-react";

const AuthContext = createContext({});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏™‡∏°‡∏≠
  const router = useRouter();
  const pathname = usePathname();

  // üü¢ Effect 1: ‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login (‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ Email ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (toLowerCase)
        if (currentUser.email.toLowerCase().endsWith("@fufonglabs.com")) {
          setUser(currentUser);
        } else {
          await signOut(auth);
          setUser(null);
          alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ @fufonglabs.com ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        }
      } else {
        setUser(null);
      }
      setLoading(false); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á)
    });

    return () => unsubscribe();
  }, []); // ‚úÖ ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà router/pathname)

  // üî¥ Effect 2: ‡∏¢‡∏≤‡∏°‡πÄ‡∏ù‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ pathname ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ user ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
  useEffect(() => {
    if (loading) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¢‡∏π‡πà ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

    if (user) {
      // ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏°‡∏µ‡∏Ñ‡∏ô Login ‡πÅ‡∏•‡πâ‡∏ß
      if (pathname === "/login") {
        router.push("/"); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÉ‡∏´‡πâ‡πÑ‡∏•‡πà‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      }
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login
      if (pathname !== "/login") {
        router.push("/login"); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÉ‡∏´‡πâ‡πÑ‡∏•‡πà‡πÑ‡∏õ Login
      }
    }
  }, [user, loading, pathname, router]);


  // 3. ‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î (Loading Screen)
  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#F5F5F7] gap-4">
        <Loader2 className="animate-spin text-[#E60000]" size={48} />
        <p className="text-slate-400 text-sm font-light tracking-widest uppercase">Verifying Access...</p>
      </div>
    );
  }

  // 4. ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏µ‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
  if (!user && pathname !== "/login") {
    return null; 
  }

  return (
    <AuthContext.Provider value={{ user }}>
      {children}
    </AuthContext.Provider>
  );
};